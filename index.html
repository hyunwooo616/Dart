<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>프로 에임 트레이너</title>
    <style>
        body { margin: 0; overflow: hidden; background: #121212; color: white; font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; }
        
        /* 로비 UI */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.9); z-index: 1000;
        }
        .container { text-align: center; background: #1e1e1e; padding: 40px; border-radius: 20px; border: 2px solid #00ff00; width: 450px; }
        
        /* 결과 요약창 */
        #result-summary {
            margin-bottom: 20px; padding: 15px; background: #2a2a2a; border-radius: 10px; display: none;
            border: 1px solid #555;
        }
        .result-val { color: #00ff00; font-size: 1.5rem; font-weight: bold; }

        .mode-container { display: flex; flex-direction: column; gap: 15px; margin: 20px 0; }
        button {
            padding: 15px; cursor: pointer; background: #333; border: 1px solid #00ff00; border-radius: 10px;
            color: white; font-size: 1.1rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center;
        }
        button:hover { background: #00ff00; color: black; }

        .best-label { font-size: 0.8rem; color: #f1c40f; }
        .esc-warning { font-size: 13px; color: #aaa; margin-top: 15px; line-height: 1.5; }

        /* 인게임 UI */
        #ingame-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 500; display: none;
        }
        
        .status-left-top {
            position: absolute; top: 20px; left: 20px;
            display: flex; flex-direction: column; align-items: flex-start;
        }
        #combo-display {
            font-size: 50px; font-weight: 900; line-height: 1;
            text-shadow: 3px 3px 0px #000;
            transition: all 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #multiplier-display {
            font-size: 24px; color: #f1c40f; font-weight: bold;
            text-shadow: 2px 2px 0px #000; margin-top: 5px;
        }

        .top-bar { position: absolute; top: 20px; width: 100%; text-align: center; }
        #timer { font-size: 45px; color: #ff4d4d; font-weight: bold; transition: all 0.2s ease; }
        .timer-urgent { color: #ff0000 !important; transform: scale(1.3); }

        /* 거대 카운트다운 */
        #warning-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 350px; color: rgba(255, 0, 0, 0.1);
            font-weight: 900; pointer-events: none;
            display: none; z-index: 100;
        }

        /* 형광색 커서 */
        #custom-cursor {
            position: absolute; width: 12px; height: 12px; background: #00ff00;
            border-radius: 50%; pointer-events: none; z-index: 999; display: none;
            transform: translate(-50%, -50%); box-shadow: 0 0 10px #00ff00;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            20% { transform: translate(-3px, 0px); }
            40% { transform: translate(3px, 2px); }
            100% { transform: translate(0, 0); }
        }
        .shake { animation: shake 0.2s; }

        canvas { display: block; cursor: none; position: relative; z-index: 1; }
    </style>
</head>
<body>

    <div id="custom-cursor"></div>

    <div id="overlay">
        <div class="container">
            <h1>에임 트레이너</h1>
            
            <div id="result-summary">
                <div style="font-size: 0.9rem; color: #ccc; margin-bottom: 5px;">최근 기록</div>
                <div>최종 점수: <span id="last-score" class="result-val">0</span></div>
                <div>정확도: <span id="last-acc" class="result-val">0%</span></div>
            </div>

            <div class="mode-container">
                <button onclick="startGame('small')">작고 빠른 과녁 <span class="best-label">최고: <span id="hs-small">0</span></span></button>
                <button onclick="startGame('big')">크고 쉬운 과녁 <span class="best-label">최고: <span id="hs-big">0</span></span></button>
            </div>
            
            <div>
                <label>마우스 감도: <span id="sens-val" style="color:#00ff00">1.0</span></label><br>
                <input type="range" id="sens-range" min="0.1" max="5.0" step="0.1" value="1.0">
                <div class="esc-warning">
                    게임 시작 후 마우스는 고정됩니다.<br>
                    <strong>ESC 키를 절대 누르지 마세요.</strong>
                </div>
            </div>
        </div>
    </div>

    <div id="ingame-ui">
        <div class="top-bar">
            <div id="timer">20</div>
            <div style="font-size: 24px; color: #00ff00;">현재 점수: <span id="score-val">0</span></div>
        </div>
        <div class="status-left-top">
            <div id="combo-display">0 콤보</div>
            <div id="multiplier-display">보너스 x1.0</div>
        </div>
        <div id="warning-text">3</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const GAME_TIME = 20;
        const BASE_SCORE = 100;
        const MISS_PENALTY = 50;
        const MODES = {
            small: { radius: 10, count: 10 },
            big: { radius: 30, count: 8 }
        };
        const TARGET_COLORS = ['#ff4d4d', '#ffffff', '#ff4d4d', '#f1c40f'];

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const cursor = document.getElementById('custom-cursor');
        const comboEl = document.getElementById('combo-display');
        const multEl = document.getElementById('multiplier-display');
        const scoreEl = document.getElementById('score-val');
        const timerEl = document.getElementById('timer');
        const warningEl = document.getElementById('warning-text');
        const sensRange = document.getElementById('sens-range');

        let score = 0, combo = 0, timeLeft = GAME_TIME;
        let hits = 0, totalClicks = 0; 
        
        let targets = [], particles = [], gameActive = false, currentMode = '';
        let vX = window.innerWidth / 2, vY = window.innerHeight / 2, sensitivity = 1.0;
        let highScores = { small: 0, big: 0 };

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        sensRange.oninput = (e) => {
            sensitivity = parseFloat(e.target.value);
            document.getElementById('sens-val').innerText = sensitivity.toFixed(1);
        };

        window.onmousemove = (e) => {
            if (!gameActive) return;
            vX = Math.max(0, Math.min(canvas.width, vX + e.movementX * sensitivity));
            vY = Math.max(0, Math.min(canvas.height, vY + e.movementY * sensitivity));
            cursor.style.left = vX + 'px';
            cursor.style.top = vY + 'px';
        };

        function createParticles(x, y, color) {
            for (let i = 0; i < 8; i++) {
                particles.push({
                    x, y, vx: (Math.random() - 0.5) * 8, vy: (Math.random() - 0.5) * 8, life: 1.0, color
                });
            }
        }

        function updateComboUI() {
            comboEl.innerText = `${combo} 콤보`;
            const multiplier = Math.min(5, 1 + (Math.floor(combo / 5) * 0.5));
            multEl.innerText = `보너스 x${multiplier.toFixed(1)}`;
            
            let color = "#fff";
            if (combo >= 15) color = "#ff3e3e";
            else if (combo >= 10) color = "#ff9800";
            else if (combo >= 5) color = "#ffeb3b";
            comboEl.style.color = color;
        }

        window.onmousedown = () => {
            if (!gameActive) return;
            totalClicks++;
            let hitIdx = -1;
            for (let i = targets.length - 1; i >= 0; i--) {
                const t = targets[i];
                if (Math.sqrt((vX - t.x)**2 + (vY - t.y)**2) <= t.r) { hitIdx = i; break; }
            }

            if (hitIdx !== -1) {
                hits++;
                combo++;
                const multiplier = Math.min(5, 1 + (Math.floor(combo / 5) * 0.5));
                score += Math.floor(BASE_SCORE * multiplier);
                createParticles(targets[hitIdx].x, targets[hitIdx].y, '#00ff00');
                targets.splice(hitIdx, 1);
                targets.push(getPos(MODES[currentMode].radius));
                comboEl.style.transform = "scale(1.2)";
                setTimeout(() => { comboEl.style.transform = "scale(1)"; }, 100);
            } else {
                combo = 0;
                score = Math.max(0, score - MISS_PENALTY);
                canvas.classList.remove('shake');
                void canvas.offsetWidth;
                canvas.classList.add('shake');
            }
            scoreEl.innerText = score;
            updateComboUI();
        };

        function getPos(r) {
            let x, y, overlap, tries = 0;
            do {
                overlap = false;
                x = Math.random() * (canvas.width - 200) + 100;
                y = Math.random() * (canvas.height - 200) + 100;
                for (let t of targets) {
                    if (Math.sqrt((x - t.x)**2 + (y - t.y)**2) < (r + t.r + 20)) { overlap = true; break; }
                }
                tries++;
            } while (overlap && tries < 100);
            return { x, y, r };
        }

        function startGame(mode) {
            currentMode = mode;
            score = 0; combo = 0; timeLeft = GAME_TIME; hits = 0; totalClicks = 0;
            targets = []; particles = [];
            vX = canvas.width / 2; vY = canvas.height / 2;
            scoreEl.innerText = "0";
            timerEl.innerText = timeLeft;
            timerEl.classList.remove('timer-urgent');
            warningEl.style.display = 'none';
            updateComboUI();
            for(let i=0; i < MODES[mode].count; i++) targets.push(getPos(MODES[mode].radius));
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('ingame-ui').style.display = 'block';
            cursor.style.display = 'block';
            canvas.requestPointerLock();
            gameActive = true;
            render();

            const timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = timeLeft;
                if (timeLeft <= 3 && timeLeft > 0) {
                    timerEl.classList.add('timer-urgent');
                    warningEl.innerText = timeLeft;
                    warningEl.style.display = 'block';
                }
                if (timeLeft <= 0) { clearInterval(timerInterval); endGame(); }
            }, 1000);
        }

        function endGame() {
            gameActive = false;
            document.exitPointerLock();
            warningEl.style.display = 'none';
            const accuracy = totalClicks > 0 ? Math.round((hits / totalClicks) * 100) : 0;
            document.getElementById('last-score').innerText = score;
            document.getElementById('last-acc').innerText = accuracy + "%";
            document.getElementById('result-summary').style.display = 'block';
            if (score > highScores[currentMode]) {
                highScores[currentMode] = score;
                document.getElementById(`hs-${currentMode}`).innerText = score;
            }
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('ingame-ui').style.display = 'none';
            cursor.style.display = 'none';
        }

        function render() {
            if (!gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 4, 4);
                p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                if (p.life <= 0) particles.splice(i, 1);
            }
            ctx.globalAlpha = 1.0;
            targets.forEach(t => {
                const steps = [1, 0.7, 0.4, 0.15];
                steps.forEach((s, i) => {
                    ctx.beginPath(); ctx.arc(t.x, t.y, t.r * s, 0, Math.PI * 2);
                    ctx.fillStyle = TARGET_COLORS[i]; ctx.fill(); ctx.stroke();
                });
            });
            requestAnimationFrame(render);
        }

        window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    </script>
</body>
</html>